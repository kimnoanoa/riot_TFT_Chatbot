<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TFT Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</head>

<body>
  <div class="stars" id="stars"></div>

  <!-- ğŸ® í—¤ë” -->
  <header class="hud-header">
    <a href="{{ url_for('index') }}" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <div class="hud-center">
      <img src="{{ url_for('static', filename='images/icon.png') }}" alt="TFT" class="tft-logo">
      <h1 class="hud-title">TFT ChatBot</h1>
      <span class="hud-patch">Patch 15.3 | Beta</span>
    </div>
  </header>

  <!-- ğŸ§© ì‹œë„ˆì§€ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´í„° ë²„íŠ¼ -->
  <div style="text-align:center;">
    <a href="{{ url_for('synergy') }}" class="simulator-btn" target="_blank">
      <i class="fas fa-magic"></i> ì‹œë„ˆì§€ ì˜ˆì¸¡ ì‹œë®¬ë ˆì´í„° 
    </a>
  </div>

  <!-- ğŸ’¬ ì±„íŒ…ì°½ -->
  <div class="chat-container">
    <div id="chatbox"></div>

    <div class="input-area">
      <input id="userInput" placeholder="ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•˜ì„¸ìš”!" />
      <button onclick="sendMsg()">ë³´ë‚´ê¸°</button>
    </div>
  </div>

  <script>
    // ğŸŒ  ë³„ ë°°ê²½
    const starsContainer = document.getElementById("stars");
    for (let i = 0; i < 80; i++) {
      const star = document.createElement("div");
      star.className = "star";
      star.style.left = Math.random() * 100 + "%";
      star.style.top = Math.random() * 100 + "%";
      star.style.animationDelay = Math.random() * 3 + "s";
      star.style.width = star.style.height = Math.random() * 2 + 1 + "px";
      starsContainer.appendChild(star);
    }

    // ğŸ§© ëœë¤ ë´‡ ì´ë¯¸ì§€
    const botImages = [
      "{{ url_for('static', filename='images/bot1.jpg') }}",
      "{{ url_for('static', filename='images/bot2.jpg') }}",
      "{{ url_for('static', filename='images/bot3.jpg') }}",
      "{{ url_for('static', filename='images/bot4.jpg') }}",
      "{{ url_for('static', filename='images/bot5.jpg') }}",
      "{{ url_for('static', filename='images/bot6.jpg') }}"
    ];
    const randomBotImage = botImages[Math.floor(Math.random() * botImages.length)];

    // âœ… ì¸ì‚¿ë§
    function showWelcomeMessage() {
      const chatbox = document.getElementById("chatbox");
      const botRow = document.createElement("div");
      botRow.className = "chat-row bot fade-in";
      botRow.innerHTML = `
        <img src="${randomBotImage}" class="bot-icon" alt="ë´‡">
        <div class='bubble bot-bubble'>í™˜ì˜í•©ë‹ˆë‹¤, ì „ëµê°€ë‹˜!ğŸ‘‹ <br>ë¡¤í† ì²´ìŠ¤ ì±—ë´‡ì…ë‹ˆë‹¤.<br>ì±”í”¼ì–¸ ì´ë¦„ì´ë‚˜ ë± ê´€ë ¨ ì§ˆë¬¸ì„ ì…ë ¥í•´ë³´ì„¸ìš”.<br>ì „ì  ê²€ìƒ‰ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤ ğŸ˜<br><small>ì „ì ê²€ìƒ‰ ex) hide on bush #kr1</small> </div>
      `;
      chatbox.appendChild(botRow);
    }

    // ğŸ§  ë©”ì‹œì§€ ì „ì†¡
    async function sendMsg() {
      const input = document.getElementById("userInput");
      const chatbox = document.getElementById("chatbox");
      const msg = input.value.trim();
      if (!msg) return;

      // ì‚¬ìš©ì ë©”ì‹œì§€
      const userMsg = document.createElement("div");
      userMsg.className = "chat-row user fade-in";
      userMsg.innerHTML = `<div class='bubble user-bubble'>${msg}</div>`;
      chatbox.appendChild(userMsg);
      input.value = "";
      chatbox.scrollTop = chatbox.scrollHeight;

      // ğŸ•“ ë´‡ ì…ë ¥ì¤‘ í‘œì‹œ
      const typingBubble = document.createElement("div");
      typingBubble.className = "chat-row bot fade-in";
      typingBubble.id = "typingBubble";
      typingBubble.innerHTML = `
        <img src="${randomBotImage}" class="bot-icon" alt="ë´‡">
        <div class='bubble bot-bubble'>ì…ë ¥ ì¤‘...</div>
      `;
      chatbox.appendChild(typingBubble);
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });
        const data = await res.json();

        // ì…ë ¥ì¤‘ ë§í’ì„  ì œê±°
        const typingElement = document.getElementById("typingBubble");
        if (typingElement) typingElement.remove();

        // ì‘ë‹µ í‘œì‹œ
        const botRow = document.createElement("div");
        botRow.className = "chat-row bot fade-in";
        botRow.innerHTML = `
          <img src="${randomBotImage}" class="bot-icon" alt="ë´‡">
          <div class='bubble bot-bubble'>${data.reply}</div>
        `;
        chatbox.appendChild(botRow);
        chatbox.scrollTop = chatbox.scrollHeight;

      } catch (err) {
        const typingElement = document.getElementById("typingBubble");
        if (typingElement) typingElement.remove();

        const botRow = document.createElement("div");
        botRow.className = "chat-row bot fade-in";
        botRow.innerHTML = `
          <img src="${randomBotImage}" class="bot-icon" alt="ë´‡">
          <div class='bubble bot-bubble'>
            âš ï¸ì„œë²„ ì‘ë‹µì´ ì§€ì—°ë˜ê³  ìˆì–´ìš”.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!
          </div>
        `;
        chatbox.appendChild(botRow);
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    // âœ… ì¸ì‚¿ë§ + ì—”í„°í‚¤
    document.addEventListener("DOMContentLoaded", () => {
      showWelcomeMessage();
      const input = document.getElementById("userInput");
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMsg();
        }
      });
    });
  </script>
</body>
</html>
