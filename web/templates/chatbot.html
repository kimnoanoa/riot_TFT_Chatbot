<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>TFT Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</head>

<body>
  <div class="stars" id="stars"></div>

  <!-- 🎮 헤더 -->
  <header class="hud-header">
    <a href="{{ url_for('index') }}" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <div class="hud-center">
      <img src="{{ url_for('static', filename='images/icon.png') }}" alt="TFT" class="tft-logo">
      <h1 class="hud-title">TFT ChatBot</h1>
      <span class="hud-patch">Patch 15.3 | Beta</span>
    </div>
  </header>

  <!-- 🧩 시너지 예측 시뮬레이터 버튼 -->
  <div style="text-align:center;">
    <a href="{{ url_for('synergy') }}" class="simulator-btn" target="_blank">
      <i class="fas fa-magic"></i> 시너지 예측 시뮬레이터 
    </a>
  </div>

  <!-- 💬 채팅창 -->
  <div class="chat-container">
    <div id="chatbox"></div>

    <div class="input-area">
      <input id="userInput" placeholder="궁금한 점을 입력하세요!" />
      <button onclick="sendMsg()">보내기</button>
    </div>
  </div>

  <script>
    // 🌠 별 배경
    const starsContainer = document.getElementById("stars");
    for (let i = 0; i < 80; i++) {
      const star = document.createElement("div");
      star.className = "star";
      star.style.left = Math.random() * 100 + "%";
      star.style.top = Math.random() * 100 + "%";
      star.style.animationDelay = Math.random() * 3 + "s";
      star.style.width = star.style.height = Math.random() * 2 + 1 + "px";
      starsContainer.appendChild(star);
    }

    // 🧩 랜덤 봇 이미지
    const botImages = [
      "{{ url_for('static', filename='images/bot1.jpg') }}",
      "{{ url_for('static', filename='images/bot2.jpg') }}",
      "{{ url_for('static', filename='images/bot3.jpg') }}",
      "{{ url_for('static', filename='images/bot4.jpg') }}",
      "{{ url_for('static', filename='images/bot5.jpg') }}",
      "{{ url_for('static', filename='images/bot6.jpg') }}"
    ];
    const randomBotImage = botImages[Math.floor(Math.random() * botImages.length)];

    // ✅ 인삿말
    function showWelcomeMessage() {
      const chatbox = document.getElementById("chatbox");
      const botRow = document.createElement("div");
      botRow.className = "chat-row bot fade-in";
      botRow.innerHTML = `
        <img src="${randomBotImage}" class="bot-icon" alt="봇">
        <div class='bubble bot-bubble'>환영합니다, 전략가님!👋 <br>롤토체스 챗봇입니다.<br>챔피언 이름이나 덱 관련 질문을 입력해보세요.<br>전적 검색도 가능합니다 😎<br><small>전적검색 ex) hide on bush #kr1</small> </div>
      `;
      chatbox.appendChild(botRow);
    }

    // 🧠 메시지 전송
    async function sendMsg() {
      const input = document.getElementById("userInput");
      const chatbox = document.getElementById("chatbox");
      const msg = input.value.trim();
      if (!msg) return;

      // 사용자 메시지
      const userMsg = document.createElement("div");
      userMsg.className = "chat-row user fade-in";
      userMsg.innerHTML = `<div class='bubble user-bubble'>${msg}</div>`;
      chatbox.appendChild(userMsg);
      input.value = "";
      chatbox.scrollTop = chatbox.scrollHeight;

      // 🕓 봇 입력중 표시
      const typingBubble = document.createElement("div");
      typingBubble.className = "chat-row bot fade-in";
      typingBubble.id = "typingBubble";
      typingBubble.innerHTML = `
        <img src="${randomBotImage}" class="bot-icon" alt="봇">
        <div class='bubble bot-bubble'>입력 중...</div>
      `;
      chatbox.appendChild(typingBubble);
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const res = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });
        const data = await res.json();

        // 입력중 말풍선 제거
        const typingElement = document.getElementById("typingBubble");
        if (typingElement) typingElement.remove();

        // 응답 표시
        const botRow = document.createElement("div");
        botRow.className = "chat-row bot fade-in";
        botRow.innerHTML = `
          <img src="${randomBotImage}" class="bot-icon" alt="봇">
          <div class='bubble bot-bubble'>${data.reply}</div>
        `;
        chatbox.appendChild(botRow);
        chatbox.scrollTop = chatbox.scrollHeight;

      } catch (err) {
        const typingElement = document.getElementById("typingBubble");
        if (typingElement) typingElement.remove();

        const botRow = document.createElement("div");
        botRow.className = "chat-row bot fade-in";
        botRow.innerHTML = `
          <img src="${randomBotImage}" class="bot-icon" alt="봇">
          <div class='bubble bot-bubble'>
            ⚠️서버 응답이 지연되고 있어요.<br>잠시 후 다시 시도해주세요!
          </div>
        `;
        chatbox.appendChild(botRow);
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    // ✅ 인삿말 + 엔터키
    document.addEventListener("DOMContentLoaded", () => {
      showWelcomeMessage();
      const input = document.getElementById("userInput");
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          sendMsg();
        }
      });
    });
  </script>
</body>
</html>
